#!/usr/bin/env bash

set -e

export PATH=/home/vcap/app/bin:$PATH

declare -a perftest_opts

[ -z "$MULTI_ACK_EVERY" ] ||
  perftest_opts+=(--multiAckEvery "$MULTI_ACK_EVERY")

[ -z "$QOS" ] ||
  perftest_opts+=(--qos "$QOS")

[ -z "$AUTO_ACK" ] ||
  perftest_opts+=(--autoack)

[ -z "$CHANNELS_PER_PRODUCER" ] ||
  perftest_opts+=(--producerChannelCount "$CHANNELS_PER_PRODUCER")

[ -z "$CHANNELS_PER_CONSUMER" ] ||
  perftest_opts+=(--consumerChannelCount "$CHANNELS_PER_CONSUMER")

_start_command com.rabbitmq.perf.PerfTest \
  --uris "$(_amqp_urls)" \
  --size "${MSG_SIZE:?must be set}" \
  --interval "${METRICS_SAMPLING_INTEVAL:?must be set}" \
  --queue "${QUEUE:?must be set}" \
  --consumers "${CONSUMERS:?must be set}" \
  --producers "${PRODUCERS:?must be set}" \
  --routingKey "${ROUTING_KEY:?must be set}" \
  --autoDelete "${AUTO_DELETE:=true}" \
  --queueArgs "$QUEUE_ARGS" \
  "${perftest_opts[@]}" \
  --predeclared
