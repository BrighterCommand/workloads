#!/usr/bin/env bash

set -e

export PATH=/home/vcap/app/bin:$PATH

declare -a perftest_opts

[ -z "$MULTI_ACK_EVERY" ] ||
  perftest_opts+=(--multiAckEvery "$MULTI_ACK_EVERY")

[ -z "$CONFIRM_EVERY" ] ||
  perftest_opts+=(--confirm "$CONFIRM_EVERY")

[ -z "$CONFIRM_TIMEOUT" ] ||
  perftest_opts+=(--confirmTimeout "$CONFIRM_TIMEOUT")

[ -z "$QOS" ] ||
  perftest_opts+=(--qos "$QOS")

[ -z "$AUTO_ACK" ] ||
  perftest_opts+=(--autoack)

[ -z "$CHANNELS_PER_PRODUCER" ] ||
  perftest_opts+=(--producerChannelCount "$CHANNELS_PER_PRODUCER")

[ -z "$CHANNELS_PER_CONSUMER" ] ||
  perftest_opts+=(--consumerChannelCount "$CHANNELS_PER_CONSUMER")

[ -z "$QUEUE_ARGS" ] ||
  perftest_opts+=(--queueArgs "$QUEUE_ARGS")

[ -z "$CONSUMER_RATE" ] ||
  perftest_opts+=(--consumerRate "$CONSUMER_RATE")

[ -z "$MSG_FLAG" ] ||
  perftest_opts+=(--flag "$MSG_FLAG")

[ -z "$RESTART_INTERVAL" ] ||
  perftest_opts+=(--time "$RESTART_INTERVAL")

_start_command com.rabbitmq.perf.PerfTest \
  --uris "$(_amqp_urls)" \
  --size "${MSG_SIZE:?must be set}" \
  --interval "${METRICS_SAMPLING_INTERVAL:?must be set}" \
  --queue "${QUEUE:?must be set}" \
  --consumers "${CONSUMERS:?must be set}" \
  --producers "${PRODUCERS:?must be set}" \
  --routingKey "${ROUTING_KEY:?must be set}" \
  --autoDelete "${AUTO_DELETE:=true}" \
  "${perftest_opts[@]}" \
  --predeclared
